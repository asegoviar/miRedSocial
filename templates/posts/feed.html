{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Feed</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- React -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>

<body class="container mt-5">

    <h2 class="text-center mb-4">Feed Global</h2>

    <div class="text-end mb-3">
        <button class="btn btn-secondary" onclick="window.location.href='/profile/'">Volver al perfil</button>
    </div>

    <div id="feedApp"></div>

    {% verbatim %}
    <script type="text/babel">

    /* -------------------------------------------------------------
        FUNCIONES AUXILIARES: obtener token + refrescar token
    ------------------------------------------------------------- */
    async function getValidAccessToken() {
        let access = localStorage.getItem("access");
        const refresh = localStorage.getItem("refresh");

        // Verificar si el access sigue funcionando
        const check = await fetch("/api/auth/me/", {
            headers: { "Authorization": "Bearer " + access }
        });

        if (check.status !== 401) {
            return access; // access aún sirve
        }

        // Si falló → intentar refrescar
        const res = await fetch("/api/auth/refresh/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh })
        });

        if (!res.ok) {
            window.location.href = "/login/";
            return;
        }

        const data = await res.json();
        localStorage.setItem("access", data.access);
        return data.access;
    }

    /* -------------------------------------------------------------
        COMPONENTE PRINCIPAL DEL FEED
    ------------------------------------------------------------- */
    function FeedApp() {

        const [posts, setPosts] = React.useState([]);
        const [newContent, setNewContent] = React.useState("");
        const [newImage, setNewImage] = React.useState(null);
        const [preview, setPreview] = React.useState("");

        const [commentText, setCommentText] = React.useState("");
        const [selectedPostId, setSelectedPostId] = React.useState(null);

        // Cargar el feed al iniciar
        React.useEffect(() => {
            loadFeed();
        }, []);

        async function loadFeed() {
            const token = await getValidAccessToken();

            fetch("/api/posts/feed/", {
                headers: { "Authorization": "Bearer " + token }
            })
            .then(res => res.json())
            .then(data => setPosts(data));
        }

        /* -----------------------------------------------------
            CREAR POST NUEVO
        ----------------------------------------------------- */
        async function createPost(e) {
            e.preventDefault();
            const token = await getValidAccessToken();

            const formData = new FormData();
            formData.append("content", newContent);
            if (newImage) formData.append("image", newImage);

            fetch("/api/posts/create/", {
                method: "POST",
                headers: { "Authorization": "Bearer " + token },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                setNewContent("");
                setNewImage(null);
                setPreview("");
                loadFeed();
            });
        }

        function onImageChange(e) {
            const file = e.target.files[0];
            setNewImage(file);
            setPreview(URL.createObjectURL(file));
        }

        /* -----------------------------------------------------
            ABRIR COMENTARIOS DE UN POST
        ----------------------------------------------------- */
        async function openComments(postId) {
            const token = await getValidAccessToken();
            setSelectedPostId(postId);

            const res = await fetch(`/api/posts/${postId}/comments/`, {
                headers: { "Authorization": "Bearer " + token }
            });

            const data = await res.json();

            // Insertamos comentarios dentro del post seleccionado
            setPosts(prev =>
                prev.map(p => 
                    p.id === postId ? { ...p, comments: data } : p
                )
            );
        }

        /* -----------------------------------------------------
            CREAR COMENTARIO
        ----------------------------------------------------- */
        async function sendComment(e, postId) {
            e.preventDefault();
            const token = await getValidAccessToken();

            await fetch(`/api/posts/${postId}/comments/create/`, {
                method: "POST",
                headers: { 
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ content: commentText })
            });

            setCommentText("");
            openComments(postId);
        }

        /* -----------------------------------------------------
            RENDER DEL COMPONENTE
        ----------------------------------------------------- */
        return (
            <div>

                {/* FORMULARIO CREAR POST */}
                <div className="card p-3 mb-4">
                    <h5>Crear Post</h5>
                    <form onSubmit={createPost}>
                        <textarea
                            className="form-control mb-3"
                            placeholder="¿Qué estás pensando?"
                            value={newContent}
                            onChange={e => setNewContent(e.target.value)}
                        />

                        {preview && (
                            <div className="mb-3 text-center">
                                <img src={preview} width="200" className="rounded" />
                            </div>
                        )}

                        <input type="file" className="form-control mb-3" onChange={onImageChange} />

                        <button className="btn btn-primary w-100">Publicar</button>
                    </form>
                </div>

                {/* LISTA DE POSTS */}
                {posts.map(post => (
                    <div key={post.id} className="card p-3 mb-4 shadow-sm">

                        <h6><strong>{post.author_username}</strong></h6>
                        <p>{post.content}</p>

                        {post.image && (
                            <img src={post.image} className="img-fluid rounded mb-3" />
                        )}

                        <button 
                            className="btn btn-outline-primary btn-sm"
                            onClick={() => openComments(post.id)}
                        >
                            Ver comentarios
                        </button>

                        {/* COMENTARIOS DEL POST */}
                        {selectedPostId === post.id && (
                            <div className="mt-3">
                                <hr />

                                {post.comments ? (
                                    post.comments.map(c => (
                                        <div key={c.id} className="mb-2">
                                            <strong>{c.author_username}:</strong> {c.content}
                                        </div>
                                    ))
                                ) : (
                                    <p className="text-muted">Cargando comentarios...</p>
                                )}

                                {/* FORMULARIO NUEVO COMENTARIO */}
                                <form onSubmit={(e) => sendComment(e, post.id)}>
                                    <input
                                        className="form-control mt-2"
                                        placeholder="Escribe un comentario..."
                                        value={commentText}
                                        onChange={e => setCommentText(e.target.value)}
                                    />
                                    <button className="btn btn-success btn-sm mt-2">
                                        Comentar
                                    </button>
                                </form>
                            </div>
                        )}

                    </div>
                ))}

            </div>
        );
    }

    ReactDOM.render(<FeedApp />, document.getElementById("feedApp"));

    </script>
    {% endverbatim %}

</body>
</html>
